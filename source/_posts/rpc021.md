---
title: rpc021
date: 2020-04-12 22:14:35
tags:
---

### rpc
- remote procedure call 远程过程调用
- 允许本地计算机调用远程计算机上的程序，不需要了解底层网络细节，整个过程就像调用本地一样
- 目的
  - 把远程调用做的和本地调用一般,封装掉底层网络调用的细节
  - 解决http超文本传输协议效率低
- 常见的是java的dubbo和google的grpc
- 框架涉及面
  - 网络通信
  - 超时机制
  - 协议
  - 序列化
  - 打解包
  - 编解码
  - 连接池
  - 拦截器
  - 服务发现
  - 负载均衡
  - 分布式链路追踪
  - 监控
  - 日志
  - 认证鉴权
  - 并发处理
  - 性能
  - 组件化
  - 插件体系
- 框架架构图
{% asset_img rpc.png 框架架构图 %}
- go语言
  - 简洁优雅
  - 天然支持高并发

### 原理
- 一次rpc的环节
  - socket套接字
  - 寻址
    - 服务发现
    - 负载均衡
  - 序列化和反序列化
    - 序列化是指把对象转化为二进制流的过程
    - 反序列化是指把二进制流转化为对象的过程
    - 因为数据在网络中传输都是二进制流的方式
    - 常用方式
      - json
      - protobuf
      - flatbuffers
  - 协议
  - 异常处理
- rpc框架解决的问题
  - 开发效率的问题，希望框架简单易用
  - 通信效率的问题，希望框架高效
  - 数据传输支持多种序列化方式支持自定义
  - 通用化即组件化和插件体系的支持
  - 服务治理
    - 服务发现
    - 负载均衡
    - 限流
    - 降级
    - 熔断
    - 超时
    - 重试
    - 服务追踪

### 框架概览
- 模块
  - client
  - server
  - transport 底层通信
  - codec 自定义协议/序列化和反序列化
  - pool 池化技术支持连接池/对象池
  - log
  - selector 提供寻址功能/服务发现/负载均衡
  - stream 提供客户端/服务端上下午数据透传的能力，还会支持流式传输
  - protocol 自定义协议
  - plugin 
  - interceptor 拦截器
  - metadata 提供参数传递功能
- 架构分层
  - 业务层
  - 组件层
  - 传输层
  - 插件层
- 技术选型
  - 协议
    - 选用http2解决http1.x的低效问题
    - 自定义协议
  - 开发语言
    - go没有历史包袱
    - 协程机制天然支持高并发
  - 序列化/反序列化(性能越来越高)
    - xml
    - json
    - protobuf 支持代码生成调用方式
    - thrift
    - flatbuffers
    - msgpack 支持反射调用方式
    - gogoprotobuf 
  - 服务治理
    - 服务发现选择consul（etcd比较简单）
    - 分布式链路追踪
      - 统一标准opentracing
      - 标准实现zipkin(java实现)和jaeger(go实现)

### 框架搭建-server
- server能力
  - 服务创建
  - 服务注册